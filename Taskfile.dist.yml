version: '3'

output: prefixed

vars:
  SCRIPTS: 'internal/scripts'

tasks:
  audit:
    aliases: [a]
    desc: Generate files for manual transformation audit
    cmds:
      - go run {{.SCRIPTS}}/audit/audit.go
    deps:
      - test
    generates:
      - audit/*
    sources:
      - ./*.go
      - embed/*
      - '{{.SCRIPTS}}/audit/audit.go'

  cover:
    aliases: [c]
    desc: Generate test coverage report
    cmds:
      - go test -coverprofile=coverage.out
      - go tool cover -html=coverage.out -o coverage.html
    generates:
      - ./coverage.html
      - ./coverage.out
    sources:
      - ./*.go
      - internal/tests/*.go
      - testdata/*

  embed:
    aliases: [e]
    desc: Generate embedded files from resources
    cmds:
      - go run {{.SCRIPTS}}/embed/embed.go
    deps:
      - res
    generates:
      - embed/*
    sources:
      - res/adj*
      - res/adv*
      - res/noun*
      - res/verb*
      - '{{.SCRIPTS}}/common/common.go'
      - '{{.SCRIPTS}}/embed/embed.go'

  res:
    aliases: [r]
    desc: Generate resources from WordNet lists
    cmds:
      - go run {{.SCRIPTS}}/res/res.go
    ignore_error: true
    generates:
      - res/adj
      - res/adv
      - res/noun
      - res/verb
    sources:
      - res/filters/*
      - res/misc/*
      - res/wordnet/data.*
      - '{{.SCRIPTS}}/common/common.go'
      - '{{.SCRIPTS}}/res/res.go'

  source:
    aliases: [s]
    desc: Setup WordNet source for task res
    summary: |
      Download and unpack the standalone WordNet database v3.1.

      This task is not compatible with Windows command line interfaces.
      To run it, use Unix-like shell environment, such as Git Bash.
    cmds:
      - tar -zxf res/wordnet/wn3.1.dict.tar.gz --strip-components=1 -C res/wordnet/
    deps:
      - _dlwnet
    status:
      - test -f res/wordnet/data.adj
      - test -f res/wordnet/data.adv
      - test -f res/wordnet/data.noun
      - test -f res/wordnet/data.verb

  test:
    aliases: [t]
    desc: Run tests for the package
    deps:
      - embed
    vars:
      VERBOSE: '{{default "" .VERBOSE}}'
    cmds:
      - go test {{.VERBOSE}}
    sources:
      - ./*.go
      - embed/*
      - internal/tests/*.go
      - testdata/*
      - symbols/*.go
      - go.mod

  testv:
    aliases: [tv]
    desc: Run tests with -v flag
    cmds:
      - task: test
        vars: { VERBOSE: '-v' }

  update:
    aliases: [u]
    desc: Update dependencies
    cmds:
      - go get -u
      - go mod tidy

  _dlwnet:
    desc: Internal task that ensures WordNet database tarball is present
    internal: true
    cmds:
      - mkdir -p res/wordnet
      - curl -so res/wordnet/wn3.1.dict.tar.gz https://wordnetcode.princeton.edu/wn3.1.dict.tar.gz
    status:
      - test -f res/wordnet/wn3.1.dict.tar.gz
